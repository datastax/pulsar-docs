= Using Pulsar SQL with Luna Streaming
:navtitle: Pulsar SQL with DataStax Luna Streaming
:description: This guide installs the luna streaming helm chart using minimum values for a working Pulsar cluster that includes SQL workers
:title: Pulsar SQL with DataStax Luna Streaming
:helmValuesPath: https://raw.githubusercontent.com/datastaxdevs/luna-streaming-examples/main/pulsar-sql/values.yaml

Adding the ability to query an Apache Pulsar topic data via SQL can be a powerful addition to any Enterprise. Stream processing, real-time analytics, and highly customized dashboards are just a few of the possibilities. Pulsar offers a pre-made plugin for Trino that is included in its distribution. Additionally, Pulsar has built-in options to create Trino workers and automatically configure the communications between Pulsar’s ledger and Trino.

In this guide, we will use DataStax Pulsar Helm Chart to install a Pulsar cluster and Pulsar SQL. The Trino coordinator and desired number of workers will be created directly in the cluster.

== Pre-req's

You will need the following things in place to complete this guide:

* Pulsar cli
* https://helm.sh/docs/intro/install/[Helm 3 cli^]{external-link-icon} (we used version 3.8.0)
* https://prestodb.io/docs/current/installation/cli.html[Presto cli^]{external-link-icon} (we used version 0.278.1)
* Enough access to a K8s cluster to create a namespace, deployments, and pods
* https://kubernetes.io/docs/tasks/tools/[Kubectl cli^]{external-link-icon} (we used version 1.23.4)

NOTE: Prestodb has been replaced by Trino but Apache Pulsar is using Presto’s version. The Trino cli uses the "X-TRINO-USER" header for authentications but Presto expects "X-PRESTO-USER", which is why we use the Presto cli.

== Install Luna Streaming helm chart

include::partial$install-helm.adoc[]

== Forward service port

We will need to interact with a few of the services in the K8s cluster. Let’s map a few ports to those services.

include::partial$port-forward-sql.adoc[]

include::partial$port-forward-web-service.adoc[]

== Confirm Presto is available

In your browser navigate to http://localhost:8090[http://localhost:8090^]. You should be greeted with Presto’s login.

image::presto-sql-login.png[Presto SQL login]

There is no authentication hooked up. Input whatever user name you prefer and “Log In”. This will greet you with a blank dashboard. That’s your confirmation that Presto is up and running.

image::presto-sql-dashboard.png[Presto SQL dashboard]

== Use the data-generator source to fill a topic

The minimalist helm chart values used the `datastax/lunastreaming-all` image to gain use of all the Pulsar connectors. We can use the “data-generator” source connector to create a topic and add sample data all at once. Note the use of the “public” tenant and “default” namespace. You can use whatever tenant and namespace you are comfortable with.

First, download the minimalist Pulsar client. This conf assumes the port forwarding addresses we will do in the next step.

[source,shell]
----
wget https://raw.githubusercontent.com/datastaxdevs/luna-streaming-examples/main/client.conf
----

Then set the client environment variable, remembering to replace with the absolute path to client.conf you just downloaded.

[source,shell]
----
# the client conf path must be an absolute path to the downloaded conf file
export PULSAR_CLIENT_CONF=<REPLACE_WITH /path/to/client.conf>
----

Now navigate to the Pulsar home folder and run the following command. The CLI will use the environment variable's value as configuration for interacting with the Pulsar cluster.

[source,shell]
----
./bin/pulsar-admin sources create --name generator --destination-topic-name public/default/mytopic --source-type data-generator
----

NOTE: The topic name will become a table name in Trino, so SQL naming rules apply. Names can contain only alphanumeric characters and must begin with an alphabetic character or an underscore (_).

Next, confirm the topic was created.

[source,shell]
----
./bin/pulsar-admin topics list public/default
----

You should get an output of:

----
persistent://public/default/mytopic
----

== Interact with the topic data

Now the moment of truth. Open a Presto shell session using the cli. Remember the server’s port number should match the forwarded port number from the previous step. The user can match the name you used to login but doesn’t have to.

[source,shell]
----
./presto --user test --server localhost:8090
----

Once inside the shell, let’s have a look around. First list the catalogs Presto has loaded.

[source,shell]
----
presto> show catalogs;
----

Output

[source,shell]
----
 Catalog
---------
 pulsar
 system
(2 rows)

Query 20230103_163242_00000_zvk84, FINISHED, 2 nodes
----

Notice similarities between your Pulsar tenant/namespaces and Presto’s output?!

List the tables within the pulsar.”public/default” catalog/schema.

[source,shell]
----
presto> show tables in pulsar."public/default";
----

Output

[source,shell]
----
  Table
---------
 mytopic
(1 row)

Query 20230103_163355_00001_zvk84, FINISHED, 2 nodes
----

Hey! There’s our topic that was created from the data-generator source connector earlier in the guide.

IMPORTANT: You might ask why there are quotes (“”) around the schema name. This is a result of mapping Presto primitives to Pulsar’s primitives. Presto has catalogs, schemas, and tables. Pulsar has tenants, namespaces, and topics. The Pulsar Presto plugin assumes the catalog name which leaves schema and table, so the tenant and namespace are combined with a forward slash delimited string. Presto has to see that combination as a single string, which means it needs to be wrapped in quotes.

Finally, query the table to see the first 10 rows of data.

[source,shell]
----
presto> select * from pulsar."public/default".mytopic limit 10;
----

Success! (hopefully) The output should be the 10 messages that were added to the Pulsar topic previously.

NOTE: If you didn’t want to download the Presto cli, you could also interact with the Presto client REST API. In fact thats what the cli uses to interact with the service. Here’s an example HTTP command. The response will include a “nextUri”. Follow that link to see the results.

[source,httprequest]
----
POST http://localhost:8090/v1/statement  HTTP/1.1
content-type: application/json
X-Presto-User: test

select * from pulsar."public/default".mytopic limit 10
----

Exit the presto shell

[source,shell]
----
presto> exit
----

You have successfully interacted with a Pulsar Cluster via SQL. Awesome! Want to put your new learnings to the test? Try using the Presto plugin in https://redash.io/data-sources/presto[Redash^]{external-link-icon} or https://superset.apache.org/docs/databases/presto/[Superset^]{external-link-icon} to create useful dashboards.

== Connect with JDBC

Bonus time! Try querying messages from a Java app using the Presto JDBC client. You’ll need the Java runtime for the next steps.

Create a file named “PrestoExample.java” with the following contents. Make sure to update the JDBC connection with the correct values for you environment.

[source,java]
----
include::https://raw.githubusercontent.com/datastaxdevs/luna-streaming-examples/main/pulsar-sql/PrestoExample.java[]
----

Build the java class.

[source,shell]
----
javac PrestoExample.java
----

Download https://repo1.maven.org/maven2/io/prestosql/presto-jdbc/334/presto-jdbc-334.jar[version 334 Presto JDBC driver^]{external-link-icon} to the same folder as the java class.

Run the client and observe the output.

[source,shell]
----
java -cp .:presto-jdbc-334.jar PrestoExample
----

Output

[source,shell]
----
Connection established......
{apartmentNumber=235, city=San Francisco, postalCode=29223, street=Tabor Court, streetNumber=94}
{apartmentNumber=260, city=Miami, postalCode=42228, street=Tabor Court, streetNumber=92}
{apartmentNumber=279, city=Washington, postalCode=22821, street=Summer Place, streetNumber=126}
{apartmentNumber=220, city=Miami, postalCode=71871, street=Tabor Court, streetNumber=64}
{apartmentNumber=294, city=Miami, postalCode=69067, street=Highland Place, streetNumber=167}
{apartmentNumber=142, city=Washington, postalCode=32774, street=Aster Court, streetNumber=189}
{apartmentNumber=233, city=Miami, postalCode=43499, street=Atkins Avenue, streetNumber=30}
{apartmentNumber=, city=Washington, postalCode=92651, street=Tabor Court, streetNumber=49}
{apartmentNumber=225, city=Washington, postalCode=64877, street=Tabor Court, streetNumber=160}
{apartmentNumber=66, city=New York, postalCode=45519, street=Stillwell Avenue, streetNumber=23}
----

== Clean up

Go to each window running an open process and `ctrl-c`. That will end the process. To completely remove all traces of this example, delete the K8s namespace.

[source,shell]
----
kubectl delete namespace datastax-pulsar
----

If you wanted to keep the data we added to the topic, just uninstall the Helm Chart.

[source,shell]
----
helm uninstall --namespace datastax-pulsar my-pulsar-cluster
----

== Next steps

Here are links to other guides you might be interested in:

* xref:pulsar-beam.adoc[]
* xref:admin-console-tutorial.adoc[]