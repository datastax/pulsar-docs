:activeTopics:
:messageSize: 10000
:messageThroughput: 50000
:retentionPolicy: 3600
:ttlPolicy: 24
:tieredStoragePolicy: n/a
:messageReplicationFactor: 3

// Example with high throughput for very active systems in 3 zones

= VM-based Pulsar production cluster

This page contains sizing and configuration information for a single VM-based production cluster.
The methodology and assumptions driving these recommendations are described in xref:production-cluster-sizing.adoc[].

== Sizing analysis and calculation
Remember the xref:production-cluster-sizing.adoc#aggregate-worksheet[workload aggregation worksheet]?

We're going to fill one out for our VM-based Pulsar cluster.

This cluster must throughput 50k messages per second, or 4.32 billion messages per day! We'll need to ensure we have enough resources to handle this workload.

.Workload input characteristics
[cols=2*,options=header]
|===
|*Workload input*
|*Value*

| Number of active topics
| {activeTopics}

| Average message size
| {messageSize} bytes

| Incoming message throughput
| {messageThroughput} messages per second

| Message retention
| {retentionPolicy} seconds

| TTL Policyfootnote:[Unacknowledged messages will expire after {ttlPolicy} hours. Acknowledged messages will persist in the system up to {ttlPolicy} hours.]
| {ttlPolicy} hours

| Tiered storage
| {tieredStoragePolicy}

|Message compression
|None

|Message replication factorfootnote:[This should match the number of the availability zones (see Pulsar topology information below)]
|{messageReplicationFactor}

|===

.Topology characteristics
[cols=2*,options=header]
|===
|*Topology requirements*
|*Value*

|Availability Zones per region (AZs)footnote:[Pulsar server instances (of the same component type) should be evenly distributed across 3 AZs as much as possible, with minimum 1 Pulsar server instance per component type.]
|3

|Required Pulsar server components
|Zookeepers, Bookkeepers, Brokers, Standalone autorecovery, Pulsar Proxy

|Broker to bookkeeper ratio
|1-to-5

|===

.VM hardware characteristics
[cols=2*,options=header]
|===
|*VM hardware specification*
|*Value*

|VM Hardware specification
|The disk space for bookkeeper is 4TB per bookkeeper server instancefootnote:[Effective bookkeeper ledger disk utilization percentage is 85%]

|===

== Sizing calculation

. Determine the Pulsar server instance counts for all required server component types.
.. Multiply replication factor by average message payload size by average message throughput.
+
[source,plain,subs="attributes+"]
----
Total message size (raw) =
{messageReplicationFactor} * // replication factor
{messageSize} * // average message payload size
{messageThroughput} * // average message throughput
({ttlPolicy} * {retentionPolicy})    // TTL and retention period
    = 129,600,000 MB
    â‰… 124 TB
----
.. We now know our cluster needs 124 TB of storage for Bookkeeper ledger data, so we can calculate the number of Bookkeeper nodes with the ledger disk capacity of 4TB and an 85% effective utilization ratio.
+
[source,plain]
----
Bookkeeper count (raw) = ceiling(124 / (4 * 0.85)) = 36
----

With our xref:production-cluster-sizing.adoc#assumptions[assumptions] of a 1-to-5 broker-to-bookkeeper ratio and 85% bookkeeper utilization rate, we calculate the number of broker nodes.
[source,plain]
----
Broker count (raw) = ceiling(36 / 5) = 8
----

Now that we know the estimated Bookkeeper and Broker counts, we can calculate the Pulsar topology requirements.

.Pulsar cluster component count
[cols=5*, options=header]
|===
|Pulsar server component
|Total VM count (raw)
|Total VM count (adjusted)
|Per-AZ count distribution (adjusted)
|Notes

|Zookeeper
|5
|5
|2/2/1
.5+a|* 3 AZs +
* At least 1 Pulsar server instance per AZ +
* Even distribution of Pulsar server instances across AZs

|Bookkeeper
|36
|13/13/13
|13 per AZ

|Broker
|8
|3/3/3
|3 per AZ

|Pulsar proxy
|1
|3
|1/1/1

|===

=== Determine VM node count

Now that we know the Pulsar server instance count, we can determine the VM node counts.

.Pulsar cluster CPU and memory requirements
[cols=6*, options=header]
|===
|Pulsar server component
|Pulsar server instance count
|CPU core per server instance
|Memory in GB per server instance
|Total CPU core
|Total memory in GB

|Zookeeper
|5
|1
|4
|5
|20

|Bookkeeper
|36
|4
|12
|144
|432

|Broker
|9
|8
|24
|72
|216

|Standalone autorecovery
|0
|1
|2
|3
|6

|Pulsar proxy
|3
|1
|2
|3
|6

4+|Total CPU and memory resource requirements
|227
|680

|===

== What's next?

See more production-ready sizing examples for the following scenarios:

* xref:production-cluster-sizing.adoc[]
* xref:production-cluster-multiregion.adoc[]
* xref:production-cluster-sandbox.adoc[]
