= Luna Streaming Functions

Functions are lightweight compute processes that enable you to process each message received on a topic. You can apply custom logic to that message, transforming or enriching it, and then output it to a different topic.

Functions run inside Luna Streaming and are therefore serverless. You write the code for your function in Java or Python, then upload the code. It will be automatically run for each message published to the specified input topic.

Functions are implemented using Apache Pulsar(R) functions. See https://pulsar.apache.org/docs/en/functions-overview/[Pulsar Functions overview] for more information about Pulsar functions.

== Add Functions in Luna Streaming

Add functions in the *Functions* tab of the Admin Console. 

. Select *Choose File* to choose a local Function. In this example, we chose `exclamation_function.py`.
. Choose your function's name and namespace. 
+
image::admin-console-add-function.png[Add Function in Admin Console]
[start=3]
. Choose the file you want to pull the function from and which function you want to use within that file.

Luna generates a list of acceptable classes. Python and Java functions are added a little differently from each other.

Python functions are added by loading a Python file (.py) or a zipped Python file (.zip). When adding Python files, the Class Name is specified as the name of the Python file without the extension plus the class you want to execute. 

For example, if the Python file is called `function.py` and the class is `exclamation`, then the class name would be `function.exclamation`. The file can contain multiple classes, but only one will be used. If there is no class in the Python file (when using a basic function, for example) just specify the filename without the extension (ex. `function`).

Java functions are added by loading a Java jar file (.jar). When adding Java files, you also need to specify the name of the class to execute as the function. 
[start=4]
. Your input topics, output topics, log topics, and processing guarantees will auto-populate. 

. Provide a *Configuration Key* in the dropdown menu. See the https://pulsar.apache.org/functions-rest-api/#[Pulsar Docs] for a list of configuration keys. 

. Select *Add* to add your function. 

You have created a function for this namespace. You can confirm your function was created in the *Manage* tab.

== Managing your function

You can start, stop, and restart your function by selecting *Manage* in the *Functions* dashboard. 

image::admin-console-function-added.png[Manage Functions]

=== Monitoring your function

Functions produce logs to help you in debugging. To view your function's logs, select *Logs* in the *Manage* dashboard. 

image::admin-console-logs.png[Function Log]

=== Updating your function

A function that is already running can be updated with new configuration. The following settings can be updated:

* Function code
* Output topic
* Log topic
* Number of instances
* Configuration keys

If you need to update any other setting of the function, delete and then re-add the function.

To update your function, select *Update* in the *Manage* dashboard. 

=== Deleting your function

To delete a function, select *Delete* in the *Manage* dashboard. 

A *Function-name Deleted Successfully!* flag will appear to let you know you've deleted your function.

=== Triggering your function

Triggering a function is a convenient way to test that the function is working. When you trigger a function, you are publishing a message on the functionâ€™s input topic, which triggers the function to run. 

To trigger a function, select *Trigger* in the *Manage* dashboard.

image::admin-console-trigger-function.png[Trigger Function]

Enter your message in the *Message to Send* field, and select the output topic. In this case, the trigger sends the string `Hello world!` to your exclamation function with no output function. If the function has an output topic and the function returns data to the output topic, it will be displayed. 

== Add function with Pulsar CLI 

You can also add functions using the Pulsar CLI. We will create a new Python function to consume a message from one topic, add an exclamation point, and publish the results to another topic. 

. Create the following Python function in `function.py`:
+
[source, python]
----
from pulsar import Function

class ExclamationFunction(Function):
  def __init__(self):
    pass

  def process(self, input, context):
    return input + '!'
----
+
. Deploy `function.py` to your Pulsar cluster using the Pulsar CLI:
+
[source, bash]
----
$ ./pulsar-admin functions create \
  --py function.py \
  --classname function.ExclamationFunction \
  --tenant <tenant-name> \
  --namespace default \
  --name exclamation \
  --inputs persistent:///default/
  --output persistent:///default/
----
+
+
If the function is set up and ready to accept messages, you should see "Created Successfully!"

. Use `./pulsar-admin functions list --tenant <tenant-name>` to list the functions in your tenant and confirm your new function was created.  

=== Trigger with CLI

To test a function with the Pulsar CLI instead of the Admin Console, send a test value with Pulsar CLI's `trigger`.

. Listen for messages on the output topic: 
+
[source, bash]
----
$ bin/pulsar-client consume persistent://<tenant-name>/default/<topic-name> \
  --subscription-name my-subscription
  --num-messages 0 # Listen indefinitely
----
+
. Test your exclamation function with `trigger`:
+
[source, bash]
----
$ ./pulsar-admin functions trigger \
  --name exclamation \
  --tenant <tenant-name> \
  --namespace default \
  --trigger-value "Hello world"
----
+
The trigger sends the string `Hello world` to your exclamation function. Your function should output `Hello world!` to your consumed output. 

== Next

Learn more about developing functions for Luna Streaming and Pulsar https://pulsar.apache.org/docs/en/functions-develop/[here].